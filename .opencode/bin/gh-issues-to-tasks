#!/usr/bin/env bash
# gh-issues-to-tasks - Convert GitHub issues to tasks.json format
# Usage: gh-issues-to-tasks <name> <issue1> [issue2] ... > tasks.json
# Example: gh-issues-to-tasks alpha 15 16 17 > /path/to/worktree/.ralph/tasks.json

set -euo pipefail

if [ $# -lt 2 ]; then
  echo "Usage: gh-issues-to-tasks <name> <issue1> [issue2] ..."
  echo "Output: JSON to stdout (redirect to file)"
  echo ""
  echo "Example:"
  echo "  gh-issues-to-tasks alpha 15 16 > /path/to/worktree/.ralph/tasks.json"
  exit 1
fi

NAME="$(echo "$1" | tr '[:upper:]' '[:lower:]')"
shift
ISSUES=("$@")

# Generate run_id with timestamp
RUN_ID="ralph-${NAME}-$(date +%Y%m%d-%H%M%S)"
BRANCH="ralph/${NAME}-batch"

# Start JSON
cat <<EOF
{
  "run_id": "${RUN_ID}",
  "branch": "${BRANCH}",
  "tasks": [
EOF

# Process each issue
FIRST=true
for issue in "${ISSUES[@]}"; do
  # Fetch issue data
  ISSUE_DATA=$(gh issue view "$issue" --json number,title,body)
  
  TITLE=$(echo "$ISSUE_DATA" | jq -r '.title')
  BODY=$(echo "$ISSUE_DATA" | jq -r '.body // ""')
  
  # Escape body for JSON (keep all content - full issue is Ralph's context)
  BODY_JSON=$(echo "$BODY" | jq -R -s '.')
  
  # Add comma before all but first
  if [ "$FIRST" = false ]; then
    echo ","
  fi
  FIRST=false
  
  # Output task JSON
  cat <<TASK
    {
      "id": ${issue},
      "issue": ${issue},
      "title": $(echo "$TITLE" | jq -R),
      "body": ${BODY_JSON},
      "status": "pending"
    }
TASK
done

# Close JSON
cat <<EOF

  ]
}
EOF
